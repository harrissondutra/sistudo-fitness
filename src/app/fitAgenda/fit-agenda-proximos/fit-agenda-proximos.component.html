<!-- Container principal do calend√°rio -->
<div class="calendar-container">
  <!-- Cabe√ßalho -->
  <header class="agenda-header">
    <div class="agenda-header-content">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <h1 class="agenda-title" style="margin-bottom: 0;">
          <span class="agenda-emoji">üìÖ</span>
          <span>Agendamentos</span>
        </h1>
        <a [routerLink]="['/fit-agenda/create']" class="btn-new-appointment" title="Novo agendamento" style="margin-left:0.7rem;">
          <span class="material-icons">add</span>
          <span class="btn-new-label">Novo</span>
        </a>
      </div>



    </div>
    <div class="agenda-stats-and-btn">
      <div class="agenda-stats">
        <div class="stat-item">
          <span class="stat-number">{{ totalAppointments }}</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ availableSlotsToday }}</span>
          <span class="stat-label">Dispon√≠veis hoje</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Calend√°rio -->
  <div class="agenda-proximos-calendar">
    <ng-container *ngIf="eventsLoaded">
      <full-calendar #calendar [options]="calendarOptions"></full-calendar>
      <!-- For√ßa o CSS para quebra de linha e tooltip nos eventos -->
      <style>
        .fc-event-title {
          white-space: normal !important;
          word-break: normal !important;
          overflow-wrap: break-word !important;
          line-break: normal !important;
          hyphens: none !important;
        }
        .fc-event {
          cursor: pointer;
        }
        .custom-tooltip-event {
          position: absolute;
          z-index: 9999;
          background: #222;
          color: #fff;
          padding: 0.7em 1.1em;
          border-radius: 8px;
          font-size: 1rem;
          font-family: 'Montserrat', 'Roboto', sans-serif;
          box-shadow: 0 4px 16px rgba(0,0,0,0.18);
          pointer-events: none;
          min-width: 180px;
          max-width: 320px;
          white-space: pre-line;
        }
      </style>

    </ng-container>

  </div>

  <!-- Legenda -->
  <div class="calendar-legend">
    <h4>Legenda</h4>
    <div class="legend-items">
      <div class="legend-item" *ngFor="let status of legendStatus">
        <span class="legend-color" [ngStyle]="{ 'background-color': getStatusColor(status) }"></span>
        <span>{{ status | titlecase }}</span>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhes do Evento -->
  <div class="modal-overlay" [ngClass]="{'visible': showModal}" (click)="closeModal($event)">
    <div class="event-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-group">
          <i class="icon-calendar-check"></i>
          <h3>Detalhes do Agendamento</h3>
        </div>
        <button class="close-button" (click)="closeModal(null)">
          <i class="icon-close">√ó</i>
        </button>
      </div>

      <div class="modal-content" *ngIf="modalData">
        <div class="event-info">
          <div class="info-row">
            <strong>Cliente:</strong>
            <span *ngIf="!isEditing">{{ modalData.name }}</span>
            <input
              *ngIf="isEditing"
              type="text"
              [(ngModel)]="modalData.name"
              class="edit-input"
              placeholder="Nome do cliente">
          </div>
          <div class="info-row">
            <strong>Servi√ßo:</strong>
            <span *ngIf="!isEditing" class="service-badge">{{ modalData.service || 'N√£o informado' }}</span>
            <select
              *ngIf="isEditing"
              [(ngModel)]="modalData.service"
              class="edit-select">
              <option value="">Selecione um servi√ßo</option>
              <option *ngFor="let s of serviceTypeOptions" [value]="s">{{ s }}</option>
            </select>
          </div>
          <div class="info-row">
            <strong>Status:</strong>
            <span *ngIf="!isEditing"
                  class="service-badge"
                  [style.background]="getStatusColor(statusEdit)">{{ statusEdit | titlecase }}</span>
            <select
              *ngIf="isEditing"
              [(ngModel)]="statusEdit"
              class="edit-select">
              <option *ngFor="let s of legendStatus" [value]="s">{{ s | titlecase }}</option>
            </select>
          </div>
          <div class="info-row">
            <strong>Descri√ß√£o:</strong>
            <span *ngIf="!isEditing">{{ modalData.description || 'N√£o informado' }}</span>
            <textarea
              *ngIf="isEditing"
              [(ngModel)]="modalData.description"
              class="edit-textarea"
              placeholder="Descri√ß√£o do agendamento"
              rows="3"></textarea>
          </div>
          <div class="info-row">
            <strong>Hor√°rio:</strong>
            <span *ngIf="!isEditing">{{ modalData.dateTime | date:'dd/MM/yyyy, HH:mm' }} - {{ modalData.endDate | date:'dd/MM/yyyy, HH:mm' }}</span>
            <div *ngIf="isEditing" class="edit-time-group">
              <div class="time-row">
                <label>In√≠cio:</label>
                <input
                  type="datetime-local"
                  [(ngModel)]="modalData.startString"
                  class="edit-datetime">
              </div>
              <div class="time-row">
                <label>Fim:</label>
                <input
                  type="datetime-local"
                  [(ngModel)]="modalData.endString"
                  class="edit-datetime">
              </div>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <!-- Debug tempor√°rio -->
          <p style="background: yellow; padding: 5px; margin: 10px 0; color: black; font-weight: bold;">
            DEBUG: isEditing = {{ isEditing }}
          </p>

          <!-- Bot√µes no modo visualiza√ß√£o -->
          <button *ngIf="!isEditing" class="btn-secondary" (click)="closeModalButton()">
            Fechar
          </button>
          <button *ngIf="!isEditing" class="btn-primary" (click)="startEditing()">
            Editar
          </button>
          <button *ngIf="!isEditing" class="btn-danger" (click)="handleDeleteAppointment()">
            Excluir
          </button>

          <!-- Bot√µes no modo edi√ß√£o -->
          <button *ngIf="isEditing" class="btn-secondary" (click)="cancelEditing()">
            Cancelar
          </button>
          <button *ngIf="isEditing" class="btn-primary" (click)="saveEditing()">
            Salvar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
