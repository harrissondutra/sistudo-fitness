<div class="bioimpedancia-client-select-container">
  <!-- Cabeçalho -->
  <div class="header">
    <div class="header-content">
      <button mat-icon-button class="back-button" (click)="onBack()" matTooltip="Voltar">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="title-section">
        <h1 class="page-title">
          <mat-icon class="title-icon">search</mat-icon>
          Selecionar Cliente para Bioimpedância
        </h1>
        <p class="page-subtitle">Pesquise e selecione um cliente para criar uma nova análise de bioimpedância</p>
      </div>
    </div>
  </div>

  <!-- Busca -->
  <div class="search-section">
    <mat-card class="search-card">
      <form [formGroup]="searchForm" class="search-form">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Pesquisar cliente</mat-label>
          <input matInput
                 formControlName="searchTerm"
                 placeholder="Nome, email ou telefone..."
                 autocomplete="off">
          <mat-icon matPrefix>search</mat-icon>
          @if (searchTerm?.value) {
            <button matSuffix
                    mat-icon-button
                    type="button"
                    (click)="clearSearch()"
                    matTooltip="Limpar busca">
              <mat-icon>close</mat-icon>
            </button>
          }
          @if (isSearching) {
            <mat-spinner matSuffix diameter="20"></mat-spinner>
          }
        </mat-form-field>
      </form>
    </mat-card>
  </div>

  <!-- Loading Principal -->
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Carregando clientes...</p>
    </div>
  }

  <!-- Lista de Clientes -->
  @if (!isLoading) {
    <div class="clients-section">
      @if (filteredClients.length === 0 && searchTerm?.value) {
        <mat-card class="no-results-card">
          <div class="no-results-content">
            <mat-icon>search_off</mat-icon>
            <h3>Nenhum cliente encontrado</h3>
            <p>Não foram encontrados clientes com o termo "{{ searchTerm?.value }}"</p>
            <button mat-raised-button color="primary" (click)="clearSearch()">
              <mat-icon>refresh</mat-icon>
              Limpar Busca
            </button>
          </div>
        </mat-card>
      } @else if (filteredClients.length === 0) {
        <mat-card class="no-results-card">
          <div class="no-results-content">
            <mat-icon>group_off</mat-icon>
            <h3>Nenhum cliente cadastrado</h3>
            <p>Não há clientes cadastrados no sistema</p>
            <button mat-raised-button color="primary" (click)="onBack()">
              <mat-icon>arrow_back</mat-icon>
              Voltar
            </button>
          </div>
        </mat-card>
      } @else {
        <!-- Contador de Resultados -->
        <div class="results-info">
          <mat-icon>group</mat-icon>
          <span>
            {{ filteredClients.length }}
            {{ filteredClients.length === 1 ? 'cliente encontrado' : 'clientes encontrados' }}
          </span>
        </div>

        <!-- Tabela de Clientes -->
        <mat-card class="clients-table-card">
          <div class="table-container">
            <table mat-table [dataSource]="filteredClients" class="clients-table">

              <!-- Coluna Avatar -->
              <ng-container matColumnDef="avatar">
                <th mat-header-cell *matHeaderCellDef>Foto</th>
                <td mat-cell *matCellDef="let client">
                  <div class="client-avatar">
                    @if (client.evolutionPhotos?.length) {
                      <img [src]="client.evolutionPhotos[0]" [alt]="client.name + ' - Foto'">
                    } @else {
                      <mat-icon>person</mat-icon>
                    }
                  </div>
                </td>
              </ng-container>

              <!-- Coluna Nome -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Nome</th>
                <td mat-cell *matCellDef="let client">
                  <div class="client-info">
                    <span class="client-name">{{ client.name }}</span>
                    @if (client.phone) {
                      <span class="client-phone">{{ client.phone }}</span>
                    }
                  </div>
                </td>
              </ng-container>

              <!-- Coluna Email -->
              <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef>Email</th>
                <td mat-cell *matCellDef="let client">
                  <span class="client-email">{{ client.email }}</span>
                </td>
              </ng-container>

              <!-- Coluna Idade -->
              <ng-container matColumnDef="age">
                <th mat-header-cell *matHeaderCellDef>Idade</th>
                <td mat-cell *matCellDef="let client">
                  @if (calculateAge(client.dateOfBirth)) {
                    <span class="client-age">{{ calculateAge(client.dateOfBirth) }} anos</span>
                  } @else {
                    <span class="client-age-unknown">-</span>
                  }
                </td>
              </ng-container>

              <!-- Coluna Última Bioimpedância -->
              <ng-container matColumnDef="lastBioimpedancia">
                <th mat-header-cell *matHeaderCellDef>Última Bioimpedância</th>
                <td mat-cell *matCellDef="let client">
                  <div class="last-bioimpedancia">
                    @if (client.lastBioimpedancia) {
                      <span class="has-bioimpedancia">{{ formatLastBioimpedancia(client) }}</span>
                      <mat-icon class="bio-icon" matTooltip="Possui bioimpedância">science</mat-icon>
                    } @else {
                      <span class="no-bioimpedancia">Nenhuma</span>
                      <mat-icon class="no-bio-icon" matTooltip="Sem bioimpedância">science_off</mat-icon>
                    }
                  </div>
                </td>
              </ng-container>

              <!-- Coluna Ações -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Ações</th>
                <td mat-cell *matCellDef="let client">
                  <div class="action-buttons">
                    <!-- Botão Criar Bioimpedância -->
                    <button mat-raised-button
                            color="primary"
                            (click)="onCreateBioimpedancia(client)"
                            matTooltip="Criar nova bioimpedância">
                      <mat-icon>add</mat-icon>
                      Nova Bio
                    </button>

                    <!-- Botão Ver Histórico (sempre visível) -->
                    <button mat-button
                            [color]="client.lastBioimpedancia ? 'accent' : 'warn'"
                            (click)="onViewHistory(client.id)"
                            [matTooltip]="client.lastBioimpedancia ? 'Ver histórico de bioimpedâncias' : 'Ver página de histórico (sem dados)'">
                      <mat-icon>{{ client.lastBioimpedancia ? 'history' : 'history_off' }}</mat-icon>
                      {{ client.lastBioimpedancia ? 'Histórico' : 'Histórico' }}
                    </button>

                    <!-- Botão Ver Cliente -->
                    <button mat-icon-button
                            (click)="onViewClient(client)"
                            matTooltip="Ver perfil do cliente">
                      <mat-icon>visibility</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            </table>
          </div>
        </mat-card>
      }
    </div>
  }
</div>
