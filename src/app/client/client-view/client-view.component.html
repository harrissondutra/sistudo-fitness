<!-- Container Principal -->
<div class="trainning-container">
  <!-- Cabeçalho -->
  <div class="header">
    <ng-container *ngIf="client && client.evolutionPhotos && client.evolutionPhotos.length > 0; else noAvatar">
      <img [src]="client.evolutionPhotos[0]" alt="Client Avatar" class="client-avatar">
    </ng-container>
    <ng-template #noAvatar>
      <div class="client-avatar">
        <mat-icon>fitness_center</mat-icon>
      </div>
    </ng-template>
    <div class="header-content">
      <h1>{{ client?.name || 'Cliente' }}</h1>
      <p class="subtitle">Detalhes do Cliente e Treinos</p>
    </div>
  </div>

  @if (client) {
  <div class="content">
    <!-- Linha para Informações Pessoais -->
    <div class="dashboard-row dashboard-row-personal-info">
      <!-- Seção de Informações Pessoais -->
      <div class="info-section personal-info-section">
        <h2>
          <mat-icon>info</mat-icon>
          Informações Pessoais
          <button mat-icon-button color="primary" (click)="editClientDetails(client.id?.toString())"
            matTooltip="Editar Informações Pessoais">
            <mat-icon>edit</mat-icon>
          </button>
        </h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">E-mail:</span>
            <span class="value">{{ client.email }}</span>
          </div>
          <div class="info-item">
            <span class="label">Nascimento:</span>
            <span class="value">
              {{ client.dateOfBirth ? (client.dateOfBirth | date:'dd/MM/yyyy') : '-' }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">Altura:</span>
            <span class="value">{{ client.height != null ? client.height + ' cm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Peso:</span>
            <span class="value">{{ client.weight != null ? client.weight + ' kg' : '-' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Linha para Medidas Atuais (ocupando 3/3) -->
    <div class="dashboard-row dashboard-row-measures">
      <!-- Seção de Medidas Atuais -->
      <div class="info-section measures-section">
        <h2>
          <mat-icon>fitness_center</mat-icon>
          Medidas Atuais
          <button mat-icon-button color="primary" (click)="editMeasures(client.id?.toString())"
            matTooltip="Editar Medidas Atuais">
            <mat-icon>edit</mat-icon>
          </button>
        </h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Ombro:</span>
            <span class="value">{{ client?.measure?.ombro != null ? client?.measure?.ombro + ' cm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Peitoral:</span>
            <span class="value">{{ client?.measure?.peitoral != null ? client?.measure?.peitoral + ' cm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Cintura:</span>
            <span class="value">{{ client?.measure?.cintura != null ? client?.measure?.cintura + ' cm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Quadril:</span>
            <span class="value">{{ client?.measure?.quadril != null ? client?.measure?.quadril + ' cm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Abdômen:</span>
            <span class="value">{{ client?.measure?.abdomem != null ? client?.measure?.abdomem + ' cm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Tórax:</span>
            <span class="value">{{ client?.measure?.torax != null ? client?.measure?.torax + ' cm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Braço Direito:</span>
            <span class="value">{{ client?.measure?.bracoDireito != null ? client?.measure?.bracoDireito + ' cm' : '-'
              }}</span>
          </div>
          <div class="info-item">
            <span class="label">Braço Esquerdo:</span>
            <span class="value">{{ client?.measure?.bracoEsquerdo != null ? client?.measure?.bracoEsquerdo + ' cm' :
              '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Coxa Direita:</span>
            <span class="value">{{ client?.measure?.coxaDireita != null ? client?.measure?.coxaDireita + ' cm' : '-'
              }}</span>
          </div>
          <div class="info-item">
            <span class="label">Coxa Esquerda:</span>
            <span class="value">{{ client?.measure?.coxaEsquerda != null ? client?.measure?.coxaEsquerda + ' cm' :
              '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Panturrilha Direita:</span>
            <span class="value">{{ client?.measure?.panturrilhaDireita != null ? client?.measure?.panturrilhaDireita + '
              cm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Panturrilha Esquerda:</span>
            <span class="value">{{ client?.measure?.panturrilhaEsquerda != null ? client?.measure?.panturrilhaEsquerda
              + ' cm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Abdominal:</span>
            <span class="value">{{ client?.measure?.abdominal != null ? client?.measure?.abdominal + ' mm' : '-'
              }}</span>
          </div>
          <div class="info-item">
            <span class="label">Suprailíaca:</span>
            <span class="value">{{ client?.measure?.suprailiaca != null ? client?.measure?.suprailiaca + ' mm' : '-'
              }}</span>
          </div>
          <div class="info-item">
            <span class="label">Subescapular:</span>
            <span class="value">{{ client?.measure?.subescapular != null ? client?.measure?.subescapular + ' mm' : '-'
              }}</span>
          </div>
          <div class="info-item">
            <span class="label">Tríceps:</span>
            <span class="value">{{ client?.measure?.triceps != null ? client?.measure?.triceps + ' mm' : '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Axilar Média:</span>
            <span class="value">{{ client?.measure?.axilar != null ? client?.measure?.axilar + ' mm' : '-' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Nova linha para profissionais associados -->
    <div class="dashboard-row dashboard-row-professionals">
      <!-- Seção de Médico(s) Associado(s) -->
      <div class="info-section associated-professionals-section">
        <h2>
          <mat-icon>local_hospital</mat-icon>
          Médico(s) Associado(s)
          <button mat-icon-button color="primary" (click)="openAddDoctorDialog()" matTooltip="Adicionar Médico">
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        </h2>
        <ng-container *ngIf="associatedDoctors.length > 0; else noAssociatedDoctors">
          <div class="info-grid">
            <div class="info-item" *ngFor="let doctor of associatedDoctors">
              <span class="label">Nome:</span>
              <span class="value">{{ doctor.name }}</span>
              <span class="label">Email:</span>
              <span class="value">{{ doctor.email || '-' }}</span>
              <span class="label">Especialidade:</span>
              <span class="value">{{ doctor.specialty || '-' }}</span>
              <span class="label">CRM:</span>
              <span class="value">{{ doctor.crm || '-' }}</span>
              <div class="action-container">
                <button mat-button class="remove-button" (click)="removeDoctor(doctor)" matTooltip="Desassociar médico">
                  <mat-icon>link_off</mat-icon>
                  <span>Desassociar</span>
                </button>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #noAssociatedDoctors>
          <div class="no-data-row">
            <p>Nenhum médico associado a este cliente.</p>
          </div>
        </ng-template>
      </div>

      <!-- Seção de Personal(is) Associado(s) -->
      <div class="info-section associated-professionals-section">
        <h2>
          <mat-icon>person</mat-icon>
          Personal(is) Associado(s)
          <button mat-icon-button color="primary" (click)="openAddPersonalDialog()" matTooltip="Adicionar Personal">
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        </h2>
        <ng-container *ngIf="associatedPersonals.length > 0; else noAssociatedPersonals">
          <div class="info-grid">
            <div class="info-item" *ngFor="let personal of associatedPersonals">
              <span class="label">Nome:</span>
              <span class="value">{{ personal.name }}</span>
              <span class="label">Email:</span>
              <span class="value">{{ personal.email || '-' }}</span>
              <span class="label">CREF:</span>
              <span class="value">{{ personal.registry || personal.registry || '-' }}</span>
              <div class="action-container">
                <button mat-button class="remove-button" (click)="removePersonal(personal)"
                  matTooltip="Desassociar personal">
                  <mat-icon>link_off</mat-icon>
                  <span>Desassociar</span>
                </button>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #noAssociatedPersonals>
          <div class="no-data-row">
            <p>Nenhum personal associado a este cliente.</p>
          </div>
        </ng-template>
      </div>

      <!-- Seção de Nutricionista(s) Associado(s) -->
      <div class="info-section associated-professionals-section">
        <h2>
          <mat-icon>restaurant</mat-icon>
          Nutricionista(s) Associado(s)
          <button mat-icon-button color="primary" (click)="openAddNutritionistDialog()"
            matTooltip="Adicionar Nutricionista">
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        </h2>
        <ng-container *ngIf="associatedNutritionists.length > 0; else noAssociatedNutritionists">
          <div class="info-grid">
            <div class="info-item" *ngFor="let nutritionist of associatedNutritionists">
              <span class="label">Nome:</span>
              <span class="value">{{ nutritionist.name }}</span>
              <span class="label">Email:</span>
              <span class="value">{{ nutritionist.email || '-' }}</span>
              <span class="label">CRN:</span>
              <span class="value">{{ nutritionist.registry || '-' }}</span>
              <span class="label">Especialidade:</span>
              <span class="value">{{ nutritionist.specialty || '-' }}</span>
              <div class="action-container">
                <button mat-button class="remove-button" (click)="removeNutritionist(nutritionist)"
                  matTooltip="Desassociar nutricionista">
                  <mat-icon>link_off</mat-icon>
                  <span>Desassociar</span>
                </button>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #noAssociatedNutritionists>
          <div class="no-data-row">
            <p>Nenhum nutricionista associado a este cliente.</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Linha do Dashboard Inferior: Treino Atual e Histórico de Treinos -->
    <div class="dashboard-row dashboard-row-bottom">
      <div class="exercises-section current-training-section">
        <h2>
          <mat-icon>assignment</mat-icon>
          Treino Atual
          <button mat-icon-button color="primary" (click)="assignNewTraining()" matTooltip="Atribuir novo treino">
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        </h2>

        @if (currentClientTraining) {
        <div class="current-training-details">
          <p><strong>Nome do Treino:</strong> {{ currentClientTraining.name }}</p>
          <p><strong>Período:</strong>
            <span class="training-date">
              Início: {{ currentClientTraining.startDate ? (parseDate(currentClientTraining.startDate) |
              date:'dd/MM/yyyy') : 'Não definida' }}
            </span>
            <span class="training-date" *ngIf="currentClientTraining.endDate">
              Fim: {{ parseDate(currentClientTraining.endDate) | date:'dd/MM/yyyy' }}
            </span>
          </p>
          <p><strong>Categoria:</strong> {{
            (currentClientTraining.categories && currentClientTraining.categories.length > 0 ?
            currentClientTraining.categories[0].name :
            (currentClientTraining.category || '-'))
            }}</p>
          <p><strong>Frequência Semanal:</strong> {{ currentClientTraining.weeklyFrequency || '-' }}</p>

          <h3>Exercícios:</h3>
          @if (currentClientTraining.exercises?.length) {
          <div class="exercises-list">
            @for (exercise of currentClientTraining.exercises; track exercise.id) {
            <div class="exercise-item">
              <h4>{{ exercise.name }}</h4>
              <p>
                <span class="exercise-detail">Séries: {{ exercise.sets || '-' }}</span>
                <span class="exercise-detail">Repetições: {{ exercise.reps || '-' }}</span>
                <span class="exercise-detail">Carga: {{ exercise.weight ? (exercise.weight + ' kg') : '-' }}</span>
              </p>
            </div>
            }
          </div>
          } @else {
          <p>Nenhum exercício cadastrado para este treino.</p>
          }
        </div>
        } @else {
        <div class="no-training">
  <mat-icon>sentiment_dissatisfied</mat-icon>
  <p>Nenhum treino atual atribuído a este cliente.</p>
  <mat-card class="action-card">

      <button mat-raised-button color="primary" class="assign-training-button" (click)="assignNewTraining()">
        <mat-icon>add_circle_outline</mat-icon>
        <span>Novo Treino</span>
      </button>

  </mat-card>
</div>
        }
      </div>

      <div class="exercises-section training-history-section">
        <h2>
          <mat-icon>history</mat-icon>
          Histórico de Treinos
        </h2>
        <div class="training-history-table-wrapper">
          @if (inactiveTrainings.length > 0) {
          <table class="training-table">
            <thead>
              <tr>
                <th>Nome do Treino</th>
                <th>Início</th>
                <th>Fim</th>
              </tr>
            </thead>
            <tbody>
              @for (training of inactiveTrainings; track training.id) {
              <tr>
                <td>{{ training.name || 'Sem nome' }}</td>
                <td>{{ isValidDate(training.startDate) ? (parseDate(training.startDate) | date:'dd/MM/yyyy') : '-' }}
                </td>
                <td>{{ isValidDate(training.endDate) ? (parseDate(training.endDate) | date:'dd/MM/yyyy') : '-' }}</td>

              </tr>
              }
            </tbody>
          </table>
          } @else {
          <div class="no-data-row">
            <p>Nenhum histórico de treino inativo encontrado para este cliente.</p>
          </div>
          }
        </div>
      </div>
    </div>
  </div>
  } @else {
  <div class="loading-spinner">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Carregando cliente ou cliente não encontrado...</p>
  </div>
  }

  <!-- Doctor Selection Dialog -->
  <div class="doctor-selection-dialog-overlay" *ngIf="showAddDoctorDialog" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
">
    <div class="doctor-selection-dialog" style="
    background-color: #fff;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    max-width: 500px;
    width: 90%;
    max-height: 90%;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  ">
      <div class="dialog-header" style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    ">
        <h3 style="margin: 0; color: #3f51b5;">Gerenciar Médico(s)</h3>
        <button mat-icon-button (click)="closeAddDoctorDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content" style="flex-grow: 1; overflow-y: auto;">
        <p *ngIf="availableDoctors.length === 0" style="text-align: center; color: #757575;">Nenhum médico disponível no
          sistema.</p>
        <div class="available-doctors-list" style="
        display: flex;
        flex-direction: column;
        gap: 8px;
      ">
          <mat-checkbox *ngFor="let doctor of availableDoctors || []; trackBy: trackByDoctorId"
            [checked]="isDoctorSelected(doctor.id != null ? doctor.id.toString() : '')"
            (change)="toggleDoctorSelection(doctor.id != null ? doctor.id.toString() : '')"
            style="padding: 8px; background-color: #f9f9f9; border-radius: 4px; transition: background-color 0.2s;">
            {{ doctor.name }} (CRM: {{ doctor.crm || 'N/A' }})
          </mat-checkbox>
        </div>
      </div>
      <div class="dialog-actions" style="
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    ">
        <div>
          <button mat-button (click)="closeAddDoctorDialog()">
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
        </div>
        <div style="display: flex; gap: 8px;">
          <button mat-raised-button color="warn" [disabled]="selectedDoctorIds.size === 0"
            (click)="removeSelectedDoctors()">
            <mat-icon>link_off</mat-icon>
            Desassociar
          </button>
          <button mat-raised-button color="primary" [disabled]="selectedDoctorIds.size === 0"
            (click)="saveSelectedDoctors()">
            <mat-icon>link</mat-icon>
            Associar
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Personal Selection Dialog -->
  <div class="personal-selection-dialog-overlay" *ngIf="showAddPersonalDialog" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
">
    <div class="personal-selection-dialog" style="
    background-color: #fff;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    max-width: 500px;
    width: 90%;
    max-height: 90%;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  ">
      <div class="dialog-header" style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    ">
        <h3 style="margin: 0; color: #3f51b5;">Selecionar Personal(s)</h3>
        <button mat-icon-button (click)="closeAddPersonalDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content" style="flex-grow: 1; overflow-y: auto;">
        <p *ngIf="!availablePersonals || availablePersonals.length === 0" style="text-align: center; color: #757575;">
          Nenhum personal
          disponível no sistema.</p>
        <div *ngIf="availablePersonals && availablePersonals.length > 0" class="available-personals-list" style="
        display: flex;
        flex-direction: column;
        gap: 8px;
      ">
          <mat-checkbox *ngFor="let personal of availablePersonals; trackBy: trackByPersonalId"
            [checked]="isPersonalSelected(personal?.id?.toString() || '')"
            (change)="togglePersonalSelection(personal?.id?.toString() || '')"
            style="padding: 8px; background-color: #f9f9f9; border-radius: 4px; transition: background-color 0.2s;">
            {{ personal?.name || 'Sem nome' }} (CREF: {{ personal?.registry || 'N/A' }})
          </mat-checkbox>
        </div>
      </div>
      <div class="dialog-actions" style="
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    ">
        <button mat-button (click)="closeAddPersonalDialog()">Cancelar</button>
        <button mat-raised-button color="primary" (click)="saveSelectedPersonals()">Adicionar Selecionados</button>
      </div>
    </div>
  </div>

  <!-- Nutritionist Selection Dialog -->
  <div class="nutritionist-selection-dialog-overlay" *ngIf="showAddNutritionistDialog" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  ">
    <div class="nutritionist-selection-dialog" style="
      background-color: #fff;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    ">
      <div class="dialog-header" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
      ">
        <h3 style="margin: 0; color: #3f51b5;">Selecionar Nutricionista(s)</h3>
        <button mat-icon-button (click)="closeAddNutritionistDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content" style="flex-grow: 1; overflow-y: auto;">
        <p *ngIf="availableNutritionists.length === 0" style="text-align: center; color: #757575;">Nenhum nutricionista
          disponível no sistema.</p>
        <div class="available-nutritionists-list" style="
          display: flex;
          flex-direction: column;
          gap: 8px;
        ">
          <!-- Dentro do diálogo de seleção de nutricionistas -->
          <mat-checkbox *ngFor="let nutritionist of availableNutritionists || []; trackBy: trackByNutritionistId"
            [checked]="isNutritionistSelected(nutritionist.id?.toString())"
            (change)="toggleNutritionistSelection(nutritionist.id?.toString())"
            style="padding: 8px; background-color: #f9f9f9; border-radius: 4px; transition: background-color 0.2s;">
            {{ nutritionist.name || 'Sem nome' }}
            (CRN: {{ nutritionist.registry || 'N/A' }}) - ID: {{ nutritionist.id }}
          </mat-checkbox>
        </div>
      </div>
      <div class="dialog-actions" style="
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #eee;
      ">
        <button mat-button (click)="closeAddNutritionistDialog()">Cancelar</button>
        <button mat-raised-button color="primary" (click)="saveSelectedNutritionists()">Adicionar Selecionados</button>
      </div>
    </div>
  </div>
</div>
